# .github/workflows/simple-extractor.yml
name: Simple API Extract

on:
  workflow_dispatch:
  schedule:
    - cron: '0 9 * * 1' # Lundi 9h

jobs:
  extract:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
    - uses: actions/checkout@v4
      
    - name: Extract API data
      run: |
        mkdir -p exports
        DATE=$(date +"%Y%m%d_%H%M")
        
        # Extract commits from specific repo
        curl -s "https://api.github.com/repos/ctrlclaire/pokedex/commits?per_page=20" > raw_commits.json
        
        # Check if curl succeeded
        if [ ! -s raw_commits.json ]; then
          echo "Erreur: Impossible de récupérer les données"
          exit 1
        fi
        
        # Create output file
        echo "=== COMMITS AUDIT POKEDEX - $(date) ===" > exports/commits_${DATE}.txt
        echo "Repository: ctrlclaire/pokedex" >> exports/commits_${DATE}.txt
        echo "" >> exports/commits_${DATE}.txt
        
        # Install jq if not available
        sudo apt-get update -qq && sudo apt-get install -y jq
        
        # Simple parsing with basic jq
        echo "SHA | Date | Auteur | Signé | Message" >> exports/commits_${DATE}.txt
        echo "----|----- |--------|-------|--------" >> exports/commits_${DATE}.txt
        
        # Parse JSON and format
        cat raw_commits.json | jq -r '.[] | 
        (.sha[0:7]) + " | " + 
        (.commit.author.date[0:10]) + " | " + 
        .commit.author.name + " | " + 
        (if .commit.verification.verified then "✅" else "❌" end) + " | " + 
        (.commit.message | split("\n")[0] | .[0:40])' >> exports/commits_${DATE}.txt
        
        # Simple stats
        echo "" >> exports/commits_${DATE}.txt
        echo "STATISTIQUES:" >> exports/commits_${DATE}.txt
        echo "=============" >> exports/commits_${DATE}.txt
        
        TOTAL=$(cat raw_commits.json | jq 'length')
        SIGNED=$(cat raw_commits.json | jq '[.[] | select(.commit.verification.verified == true)] | length')
        UNSIGNED=$(cat raw_commits.json | jq '[.[] | select(.commit.verification.verified == false)] | length')
        
        echo "Total commits analysés: $TOTAL" >> exports/commits_${DATE}.txt
        echo "Commits avec signature GPG: $SIGNED" >> exports/commits_${DATE}.txt
        echo "Commits sans signature: $UNSIGNED" >> exports/commits_${DATE}.txt
        
        # Verification hash
        echo "" >> exports/commits_${DATE}.txt
        echo "Hash de vérification: $(sha256sum exports/commits_${DATE}.txt | cut -d' ' -f1)" >> exports/commits_${DATE}.txt
        
        # Show content for debugging
        echo "Contenu généré:"
        cat exports/commits_${DATE}.txt
        
        rm raw_commits.json
        
    - name: Commit results
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "Simple Extractor"
        git add exports/
        git commit -m "📊 API extract - $(date '+%Y-%m-%d')" || exit 0
        git push
        
    - name: Upload
      uses: actions/upload-artifact@v4
      with:
        name: commits-extract
        path: exports/
